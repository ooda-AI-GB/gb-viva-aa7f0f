{% extends "layout/base.html" %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/projects" style="color: var(--text-secondary); text-decoration: none;">← Back to Projects</a>
</div>

<div class="card" style="margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <div>
            <h1>{{ project.name }}</h1>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <span class="badge badge-{{ project.status }}">{{ project.status|replace('_', ' ') }}</span>
                <span class="badge badge-{{ project.priority }}">{{ project.priority }}</span>
            </div>
            <p style="color: var(--text-secondary);">{{ project.description }}</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="/projects/{{ project.id }}/edit" class="btn btn-secondary">Edit</a>
            <form action="/projects/{{ project.id }}/delete" method="POST" onsubmit="return confirm('Are you sure?');">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </div>
    </div>
    
    <div class="stats-grid" style="margin-bottom: 0;">
        <div style="text-align: center;">
            <div class="stat-value">{{ progress }}%</div>
            <div class="stat-label">Progress</div>
        </div>
        <div style="text-align: center;">
            <div class="stat-value">{{ total_hours_act }}h</div>
            <div class="stat-label">Hours Logged</div>
        </div>
        <div style="text-align: center;">
            <div class="stat-value">{{ project.budget }}</div>
            <div class="stat-label">Budget ($)</div>
        </div>
        <div style="text-align: center;">
            <div class="stat-value" style="font-size: 1.25rem;">{{ project.due_date }}</div>
            <div class="stat-label">Due Date</div>
        </div>
    </div>
</div>

<div class="grid" style="grid-template-columns: 2fr 1fr; gap: 30px;">
    <!-- Tasks -->
    <div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Tasks</h3>
                <button onclick="document.getElementById('task-form').style.display='block'" class="btn btn-primary">Add Task</button>
            </div>
            
            <div id="task-form" style="display: none; margin-bottom: 20px; padding: 15px; background: var(--bg-light); border-radius: 8px;">
                <form action="/tasks" method="POST">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">Assigned To</label>
                            <input type="text" name="assigned_to" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Due Date</label>
                            <input type="date" name="due_date" class="form-control">
                        </div>
                    </div>
                    <div class="grid" style="grid-template-columns: 1fr 1fr;">
                         <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select name="priority" class="form-control">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Est. Hours</label>
                            <input type="number" step="0.5" name="estimated_hours" class="form-control">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                    <button type="button" onclick="document.getElementById('task-form').style.display='none'" class="btn btn-secondary">Cancel</button>
                </form>
            </div>

            {% for task in project.tasks %}
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding: 12px 0;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span class="badge badge-{{ task.status }}">{{ task.status|replace('_', ' ') }}</span>
                    <div>
                        <a href="/tasks/{{ task.id }}" style="font-weight: 500; text-decoration: none; color: var(--text-primary);">{{ task.title }}</a>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            {{ task.assigned_to if task.assigned_to else 'Unassigned' }} • Due {{ task.due_date }}
                        </div>
                    </div>
                </div>
                <span class="badge badge-{{ task.priority }}">{{ task.priority }}</span>
            </div>
            {% else %}
            <p>No tasks yet.</p>
            {% endfor %}
        </div>
    </div>
    
    <!-- Milestones -->
    <div>
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Milestones</h3>
                <button onclick="document.getElementById('milestone-form').style.display='block'" class="btn btn-primary" style="font-size: 0.8rem;">Add</button>
            </div>
            
            <div id="milestone-form" style="display: none; margin-bottom: 20px; padding: 10px; background: var(--bg-light); border-radius: 8px;">
                <form action="/milestones" method="POST">
                    <input type="hidden" name="project_id" value="{{ project.id }}">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Due Date</label>
                        <input type="date" name="due_date" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                    <button type="button" onclick="document.getElementById('milestone-form').style.display='none'" class="btn btn-secondary btn-sm">Cancel</button>
                </form>
            </div>

            <ul class="timeline" style="margin-top: 10px;">
            {% for m in project.milestones|sort(attribute='due_date') %}
                <li class="timeline-item">
                    <div class="timeline-marker {% if m.completed %}completed{% endif %}"></div>
                    <div style="font-weight: 600; {% if m.completed %}text-decoration: line-through; color: var(--text-secondary);{% endif %}">{{ m.title }}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">
                        Due {{ m.due_date }}
                        {% if not m.completed %}
                        <form action="/milestones/{{ m.id }}/complete" method="POST" style="display: inline;">
                            <button type="submit" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.8rem; padding: 0;">(Mark Done)</button>
                        </form>
                        {% endif %}
                    </div>
                </li>
            {% else %}
                <p>No milestones.</p>
            {% endfor %}
            </ul>
        </div>
        
        <div class="card">
            <h3>AI Insights</h3>
            <p style="font-size: 0.875rem; color: var(--text-secondary);">Generate AI insights for this project.</p>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="generateInsight('risk_assessment')" class="btn btn-secondary" style="font-size: 0.8rem;">Risks</button>
                <button onclick="generateInsight('progress_summary')" class="btn btn-secondary" style="font-size: 0.8rem;">Progress</button>
            </div>
            <div id="insight-result" style="margin-top: 15px; font-size: 0.875rem; white-space: pre-wrap;"></div>
        </div>
    </div>
</div>

<script>
async function generateInsight(type) {
    const resultDiv = document.getElementById('insight-result');
    resultDiv.innerHTML = "Generating...";
    
    try {
        const response = await fetch('/api/insights/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                project_id: {{ project.id }},
                insight_type: type
            })
        });
        const data = await response.json();
        if (data.error) {
            resultDiv.innerHTML = "Error: " + data.error;
        } else {
            resultDiv.innerHTML = "<strong>Insight:</strong><br>" + data.content;
        }
    } catch (e) {
        resultDiv.innerHTML = "Error: " + e.message;
    }
}
</script>
{% endblock %}
